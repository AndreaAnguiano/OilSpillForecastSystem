!function($){function init(plot){function plothover(e,pos,item){var offset=plot.offset();needle.x=Math.max(0,Math.min(pos.pageX-offset.left,plot.width())),needle.y=Math.max(0,Math.min(pos.pageY-offset.top,plot.height())),needle.axes_x=pos.x,plot.triggerRedrawOverlay()}function drawTooltips(ctx,drawSet){for(var keys=Object.keys(drawSet),i=0;i<keys.length;i++){var tooltip=drawSet[keys[i]],rectXPosition=needle.x+2,textXPosition=needle.x+5,textWidth=ctx.measureText(tooltip.text).width+5;needle.x+textWidth>plot.width()&&(rectXPosition-=textWidth+4,textXPosition-=textWidth+6),ctx.fillStyle="rgba(255,255,255, 0.8)",ctx.fillRect(rectXPosition,keys[i]-15,textWidth,20),ctx.fillStyle=tooltip.color,ctx.fillText(tooltip.text,textXPosition,keys[i])}}function getPoints(plot){for(var dataset=plot.getData(),points=[],i=(plot.getOptions(),0);i<dataset.length;i++){var series=dataset[i],dataset_y=series.data[needle.axes_x];if(void 0===dataset_y){for(j=0;j<series.data.length&&!(series.data[j][0]>needle.axes_x);++j);dataset_y=series.data[j]?series.data[j][1]:needle.x>-1?series.data[j-1][1]:0}if(points.push(series.needle&&series.needle.label?[needle.axes_x,dataset_y,series.needle.label(dataset_y),series.color]:[needle.axes_x,dataset_y,dataset_y,series.color]),series.fillArea&&(series.data[j]||series.data[j-1])){var min,max;needle.x>-1&&j>0?(min=series.data[j-1][3],max=series.data[j-1][4]):(min=series.data[j][3],max=series.data[j][4]),series.needle&&series.needle.label?(points.push([needle.axes_x,min,series.needle.label(min),series.color]),points.push([needle.axes_x,max,series.needle.label(max),series.color])):(points.push([needle.axes_x,min,min,series.color]),points.push([needle.axes_x,max,max,series.color]))}}return points}function padTooltips(tooltips){for(var distance=20,keys=Object.keys(tooltips),j=0;j<keys.length;j++)keys[j]=parseInt(keys[j]);keys.sort(function(a,b){return b-a});for(var k=1;k<keys.length;k++){var current=keys[k];if(keys[k-1]){var prev=keys[k-1];if(Math.abs(prev-current)<distance){if(current=Math.abs(prev-distance),tooltip=tooltips[keys[k]],delete tooltips[keys[k]],tooltips[current]){tooltips[current+1]=tooltips[current];for(var s=0;s<keys.length;s++)keys[s]===current&&keys[s]++}tooltips[current]=tooltip,keys[k]=current}}}return tooltips}function createDrawSet(points,plot){var tooltips={},options=plot.getOptions();if(options.series.stack)for(var i=0;i<points.length;i++)i-1>=0&&(points[i][1]+=points[i-1][1]);options.needle.noduplicates&&(points.length>=3&&points[1][1]===points[2][1]&&points.splice(2,1),points.length>=2&&points[1][1]===points[0][1]&&points.splice(0,1));for(var p=0;p<points.length;p++){var coords=plot.p2c({x:points[p][0],y:points[p][1]}),text=points[p][2],color=points[p][3],tooltip={text:text,color:color};if(coords.top=parseInt(coords.top,10),void 0===tooltips[coords.top])tooltips[coords.top]=tooltip;else{var top=coords.top;do top++;while(void 0!==tooltips[top]);tooltips[top]=tooltip}}return padTooltips(tooltips)}var needle={x:-1,y:-1};plot.hooks.bindEvents.push(function(plot,eventHolder){var plotOptions=plot.getOptions();plotOptions.needle!==!1&&plotOptions.needle&&$(plot.getPlaceholder()).bind("plothover",plothover)}),plot.hooks.shutdown.push(function(plot,eventHolder){$(plot.getPlaceholder()).unbind("plothover",plothover)}),plot.hooks.drawOverlay.push(function(plot,ctx){var op=plot.getOptions().needle,plotOffset=(plot.getOptions().series.stack,plot.getPlotOffset());if(ctx.save(),ctx.translate(plotOffset.left,plotOffset.top),-1!=needle.x){ctx.strokeStyle=op.lineColor,ctx.lineWidth=op.lineWidth,ctx.lineJoin="round",ctx.font=op.fontSize+" "+op.fontFace;var adj=op.lineWidth%2?.5:0;ctx.beginPath();var drawX=Math.floor(needle.x)+adj;ctx.moveTo(drawX,0),ctx.lineTo(drawX,plot.height()),ctx.stroke();var points=getPoints(plot),drawSet=createDrawSet(points,plot);drawTooltips(ctx,drawSet)}ctx.restore()})}var options={needle:{on:null,fontSize:"12px",fontFace:"Arial",lineWidth:0,lineColor:"orange"}};$.plot.plugins.push({init:init,options:options,name:"needle",version:"1.0.0"})}(jQuery);